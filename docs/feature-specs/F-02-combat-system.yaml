title: Technical Specification - Combat System
template: ~/.claude/file-templates/init-project/feature-spec/feature-title.yaml
feature_id: F-02
status: in-progress
last_updated: 2025-10-21

summary: "Turn-based combat with level selection and weapon-specific timing dial mechanics. Player selects combat level (1-20), random enemy chosen from pool. MVP0 uses single_arc pattern only, constant dial speed. Combat UI shows only HP (not full stats). Player taps moving dial with zone-based outcomes. Enemy counterattacks after player turn. Combat ends when either HP reaches 0."

functional_overview:
  core_logic: "Initiate combat when player taps active location. Load enemy data and player's equipped weapon. Display single_arc dial pattern (MVP0 only) with zone-based hit bands. Player accuracy stat adjusts zone sizes via fn_weapon_bands_adjusted(). On tap, determine hit zone (injure/miss/graze/normal/crit). Apply zone multipliers: injure=-50%, miss=0%, graze=60%, normal=100%, crit=160%+RNG. RNG adds 0-100% bonus multiplier on crit hits. Enemy counterattacks after player turn. Victory rewards materials matching enemy's style_id."
  data_schema: "Combat sessions (in-memory cache, not persistent), EnemyTypes table, Weapons table (dial patterns + hit bands), player stats (from v_player_equipped_stats view)"
  api_endpoints:
    - "POST /combat/start"
    - "POST /combat/attack"
    - "POST /combat/complete"
  integration_points:
    - "Items system (F-03) for player stats"
    - "Pets system (F-04) for pet bonus"
    - "Location system (F-01) for enemy spawn"
    - "Pool System: Enemy selection via EnemyPools based on combat level and location attributes"
    - "Style System: Enemy styles determine reward material styles (styled enemies always drop styled materials)"

detailed_design:
  business_rules:
    - "Enemy difficulty determined solely by stat scaling, not dial mechanics. Level 1 enemies remain weak regardless of player level."
    - "MVP0 simplification: Single arc pattern only, constant dial speed across all weapons, difficulty scaling through enemy stats only."
    - "Dial speed scaling reserved for post-MVP variety, not difficulty compensation."
  data_structures:
    - name: "EnemyTypes (seed data, see data-plan.yaml)"
      columns:
        - "id: UUID (PK)"
        - "name: VARCHAR (Spray Paint Goblin, Goopy Floating Eye, etc.)"
        - "base_atk: INT (baseline attack)"
        - "base_def: INT (baseline defense)"
        - "base_hp: INT (baseline HP)"
        - "tier_id: INT (FK to Tiers, determines difficulty scaling)"
        - "style_id: UUID (FK to StyleDefinitions, default normal)"
        - "NOTE: Enemy stats scale with tier: final_stats = base + offset + (tier_adds × (tier_num - 1)). Tiers can scale 1-20+. See data-plan.yaml for Tiers table and v_enemy_realized_stats view."

    - name: "Weapons (per-item timing mechanics, see data-plan.yaml)"
      columns:
        - "item_id: UUID (PK, FK to Items where category='weapon')"
        - "pattern: weapon_pattern ENUM (single_arc, dual_arcs, pulsing_arc, roulette, sawtooth) -- MVP0: single_arc only"
        - "spin_deg_per_s: NUMERIC (rotation speed in degrees/second) -- MVP0: constant speed for all weapons"
        - "deg_injure: NUMERIC (self-damage zone size in degrees)"
        - "deg_miss: NUMERIC (miss zone size in degrees)"
        - "deg_graze: NUMERIC (partial hit zone size in degrees)"
        - "deg_normal: NUMERIC (normal hit zone size in degrees)"
        - "deg_crit: NUMERIC (critical hit zone size in degrees)"
        - "NOTE: Total degrees must not exceed 360. Player accuracy scales these via fn_weapon_bands_adjusted(). MVP0: Only single_arc pattern implemented, constant dial speed for simplicity."

    - name: "combat_sessions (in-memory cache, NOT persistent database)"
      storage: "In-memory cache or Redis (15min TTL) for active combat state"
      columns:
        - "session_id: UUID (PK)"
        - "player_id: UUID"
        - "enemy_type_id: UUID"
        - "weapon_id: UUID (player's equipped weapon)"
        - "player_hp: INT (current)"
        - "enemy_hp: INT (current)"
        - "turn_count: INT"
        - "created_at: TIMESTAMP"
        - "NOTE: Ephemeral session data, cleared after combat ends or 15min timeout"

  apis:
    - method: "POST"
      endpoint: "/combat/start"
      request: "{location_id: UUID}"
      response: "{session_id, enemy: {id, type, atk, def, hp, style_id}, player_stats: {atk, def, hp}}"
      errors:
        - "404: Location not found or no enemy at location"
        - "401: Unauthorized"

    - method: "POST"
      endpoint: "/combat/attack"
      request: "{session_id: UUID, tap_position_degrees: FLOAT (0-360)}"
      response: "{hit_zone: 'injure|miss|graze|normal|crit', base_multiplier: FLOAT, crit_bonus_multiplier: FLOAT (0-1.0, only if crit), damage_dealt: INT, player_hp_remaining: INT, enemy_hp_remaining: INT, enemy_damage: INT, defense_effectiveness: FLOAT (if defense applied), combat_status: 'ongoing|victory|defeat'}"
      note: "Server uses fn_weapon_bands_adjusted() for attack. Defense uses same 5-zone system with defense bands. Enemy attacks automatically with RNG."
      errors:
        - "404: Session not found or expired"
        - "400: Invalid tap_position_degrees (must be 0-360)"

    - method: "POST"
      endpoint: "/combat/complete"
      request: "{session_id: UUID, result: 'victory|defeat'}"
      response: "{reward: {item_id, type, stats, style_id}} (null if defeat)"
      errors:
        - "404: Session not found"

  diagrams: |
    Combat Flow (Weapon-Specific Dial Mechanics):
    1. Player taps location marker → proximity check → location info modal → 'Start' button
    2. Level selection screen appears (1-20 scrollable list)
    3. Player selects combat level → random enemy chosen from level-appropriate pool
    4. Client: POST /combat/start with selected level → Get random enemy + player stats + weapon dial config
    5. Server: Load player's equipped weapon from Items → Weapons table
    6. Server: Calculate accuracy-adjusted hit bands using fn_weapon_bands_adjusted(weapon_id, player_accuracy)
    7. Server: Return enemy data (with tier-scaled stats), player stats, weapon pattern, adjusted hit bands
    8. Client: Display combat UI with enemy image, only HP display (not full stats), HP bars (styled based on enemy style_id)
    9. Player's turn: Render single_arc dial pattern (MVP0 only)
    10. Client: Animate dial rotation at constant speed (MVP0: no speed scaling)
    11. Client: Display color-coded zones based on adjusted hit bands:
       - Red zone (injure): deg_injure (self-damage, -50% multiplier)
       - Gray zone (miss): deg_miss (0% multiplier)
       - Yellow zone (graze): deg_graze (60% multiplier)
       - White zone (normal): deg_normal (100% multiplier)
       - Green zone (crit): deg_crit (160% base + 0-100% RNG bonus)
    16. Player taps → Calculate tap_position_degrees (0-360)
    17. Client: POST /combat/attack with tap_position_degrees
    12. Server: Determine hit_zone by checking tap_position against adjusted band ranges
    13. Server: Apply zone multiplier to base damage
    14. Server: If hit_zone = 'crit', roll RNG bonus multiplier (0.0-1.0) and add to base 1.6x
    15. Server: Calculate damage = (player_ATK * total_multiplier) - enemy_DEF (min 1)
    16. Server: If hit_zone = 'injure', apply negative multiplier (player takes damage)
    17. Server: Pause 1-3 seconds, then trigger enemy attack automatically with RNG damage
    18. Server: Player defense dial appears with 5 zones (fail=0%, poor=20%, okay=50%, good=75%, perfect=90% reduction)
    19. Server: Calculate defense effectiveness based on player defense timing and stats
    20. Server: Apply damage reduction: final_damage = enemy_damage × (1 - defense_effectiveness)
    21. Server: Update HPs after 1-3 second delay, return combat state
    19. Client: Display hit zone feedback (color flash, haptics, damage numbers)
    20. Client: Update HP bars
    21. If ongoing: Repeat from step 7
    22. If victory/defeat: POST /combat/complete
    23. Server: Generate reward material with enemy's style_id (styled enemies always drop styled materials)
    24. Client: Display result screen with styled reward (if victory)

    Weapon Pattern Types (MVP0: single_arc only):
    - single_arc: Standard arc with 5 color-coded bands (MVP0 implementation)
    - dual_arcs: Two parallel arcs, player can tap either for same bands (post-MVP)
    - pulsing_arc: Arc that dynamically expands/contracts, changing effective zone sizes (post-MVP)
    - roulette: Circular wheel divided into wedge-shaped zones (post-MVP)
    - sawtooth: Jagged pattern with irregular zone sizes for advanced players (post-MVP)

    Zone Outcome Multipliers (from data-plan):
    - injure: -0.5x (self-damage, player loses HP instead of enemy)
    - miss: 0.0x (no damage)
    - graze: 0.6x (partial hit)
    - normal: 1.0x (full hit)
    - crit: 1.6x base + (0.0 to 1.0) RNG bonus = total 1.6x to 2.6x

    Accuracy Scaling (fn_weapon_bands_adjusted):
    - Low accuracy (e.g., 5): Large injure/miss zones, small crit zone
    - Medium accuracy (e.g., 15): Balanced zones
    - High accuracy (e.g., 30+): Small injure/miss zones, large crit zone
    - Formula uses diminishing returns: accuracy scales bands but not linearly

    UI Requirements:
    - Dial color coding: injure=#FF4444 (red), miss=#666666 (gray), graze=#FFAA44 (yellow), normal=#FFFFFF (white), crit=#44FF44 (green)
    - Haptic feedback: Heavy impact on crit, light impact on normal, no haptic on miss
    - Animation: Screen flash on crit hit, damage number glow effect
    - Visual indicator: Moving pointer/needle shows current tap position on dial
    - Zone size visualization: Clearly delineate band boundaries with gradients or lines

dependencies:
  libraries: "SwiftUI for animations, Haptic feedback (UIImpactFeedbackGenerator)"
  services: "Backend combat logic, fn_weapon_bands_adjusted() and fn_expected_mul_quick() PostgreSQL functions, stat calculation via v_player_equipped_stats and v_enemy_realized_stats views"
  data_sources: "Player equipment from F-03 via v_player_equipped_stats, Weapons table for dial patterns, EnemyTypes with tier scaling, Tiers table (1-20+ tiers)"

implementation_status:
  progress: 85  # Backend fully implemented and tested, frontend and universal weapon config remaining
  completed_components:
    - "PostgreSQL combat functions: fn_weapon_bands_adjusted(), fn_expected_mul_quick(), fn_acc_scale(), combat_rating(), effective_hp()"
    - "Database tables: CombatSessions, EnemyPools, EnemyPoolMembers, LootPools, LootPoolEntries, Weapons"
    - "Enemy seed data: 5 enemy types (Spray Paint Goblin, Goopy Floating Eye, Feral Unicorn, Bipedal Deer, Politician) across 5 tiers"
    - "Enemy pools: 3 universal pools (levels 1, 5, 10) with 8 pool member assignments"
    - "Loot pools: 3 universal pools (levels 1, 5, 10) with 123 weighted loot entries (materials + item types)"
    - "Material seed data: 15 materials (Cactus, Coffee, Feather, Gum, Flame, Sparkles, etc.)"
    - "CombatService with full session management: startCombat, getCombatSession, recovery"
    - "Attack system: 5 hit zones (injure -50%, miss 0%, graze 60%, normal 100%, crit 160%+RNG)"
    - "Defense system: damage reduction 20-80% based on accuracy and defense timing"
    - "Loot generation with style inheritance (enemies with style_id drop matching styled materials)"
    - "Enemy selection via weighted random from pools"
    - "5 hit zone system with accuracy-based band scaling"
    - "Elo-style combat rating system"
    - "All RPC functions created and tested (/combat/start, /combat/attack, /combat/complete)"
    - "Routes and controllers complete"
    - "Counterattacks on non-injure hits"
  in_progress_components: []
  blocked_items:
    - "Universal weapon dial configuration (can use temporary config for MVP0)"
    - "Frontend SwiftUI combat UI"
  notes:
    - "Backend fully implemented and tested. Combat system is production-ready."
    - "MVP0 uses single universal weapon config - all items equipped as weapons use same dial pattern"
    - "Current pools are 'universal' filter_type - can add location-specific pools later (filter_type='location_type', filter_value='gym')"
    - "Pool system supports weighted random selection (spawn_weight, drop_weight columns)"
    - "Enemy tier scaling via Tiers table (5 tiers currently seeded)"
    - "Style system integrated: enemies with style_id drop materials with matching style_id"
    - "Next steps: (1) Create universal weapon dial config, (2) Implement frontend SwiftUI combat UI, (3) Optional: Add location-specific pools"

user_stories:
  - US-201
  - US-202
  - US-203
