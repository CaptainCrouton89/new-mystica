title: Core Gameplay Loop
template: ~/.claude/file-templates/init-project/user-flows/user-flow-title.yaml
status: draft
last_updated: 2025-01-27

key_personas:
  - "Mobile RPG Player - Enjoys progression systems and combat strategy"
  - "Location Explorer - Motivated by real-world discovery and collection"
  - "Collector - Seeks rare variants and complete sets"

primary_flows:
  - name: "Exploration & Combat Flow"
    trigger: "Player opens app and wants to discover new items/pets"
    steps:
      - "Player views map showing nearby location markers (just icons, no preview)"
      - "Player selects destination and navigates to physical location using map guidance"
      - "Player arrives at location, location icon becomes active"
      - "Player taps location marker to view encounter details"
      - "If not close enough: modal shows 'You need to be closer to start this encounter'"
      - "If close enough: modal shows location information, loot types that drop there (close to player level), and 'Start' button"
      - "Player taps 'Start' button to proceed"
      - "Level selection screen appears with scrollable list (levels 1-20 for now)"
      - "Player selects desired combat level"
      - "Combat launches with randomly chosen enemy at selected level"
      - "Combat screen shows enemy idling, dial, and only HP (not full stats display)"
      - "Player taps timing dial to set attack multiplier"
      - "Damage calculated and applied to enemy"
      - "Enemy attacks back, damage applied to player"
      - "Combat continues until player wins or loses"
      - "On victory: rewards screen shows all dropped materials and items with visual styling"
      - "On defeat: screen shows 'Return to Map' or 'Retry' options"
      - "Player returns to map view or inventory"
    outcome: "Player collects new item/pet for their inventory"
    edge_cases: |
      - Player leaves location before starting: encounter becomes inactive
      - Player loses combat: can retry immediately or return to map
      - Inventory full: prompt to discard item or manage inventory
      - GPS signal lost: pause encounter until signal restored
      - Level selection: random enemy chosen from appropriate level pool
      - Distance check: proximity required before 'Start' button becomes active
      - Styled enemies: 100% chance to drop styled materials (not 5%)

  - name: "Material Crafting Flow"
    trigger: "Player has items and materials to craft together"
    steps:
      - "Player opens crafting screen from main menu OR taps 'Craft' on item/material in inventory"
      - "If from inventory: selected item/material pre-filled in appropriate slot"
      - "If from main menu: both slots empty"
      - "Player taps item slot (left) → drawer opens showing all items with rarity borders and equipped badges"
      - "Player selects item → item fills left slot"
      - "Player taps material slot (right) → drawer opens showing materials with style borders and quantities"
      - "System filters out materials already applied to selected item (max 3, no duplicates)"
      - "Player selects material → material fills right slot"
      - "System displays stat preview: original stats vs. enhanced stats (green=increase, red=decrease)"
      - "Preview shows: item image + material icon + '?' (no spoiler), projected stats below"
      - "Player taps 'Craft' to confirm"
      - "Selected material consumed (quantity -1 from MaterialStack)"
      - "AI image generation starts (~20 seconds synchronous for MVP0)"
      - "System displays progress: 'Crafting your item... 15s remaining'"
      - "Item updated with new material, stats recalculated, new image cached"
      - "Success screen with craft count: 'X players have crafted this combo'"
      - "Options: 'View Item', 'Return to Crafting', 'Return to Inventory'"
    outcome: "Player creates customized item with material-based enhancements via dedicated crafting screen"
    edge_cases: |
      - No materials available: material slot shows "Collect materials from combat"
      - Item already has 3 materials: material drawer shows warning, materials greyed out
      - Image generation fails: retry option or fallback to base item appearance
      - Material quantity = 0: material greyed out in drawer
      - Equipped item crafted: stats update immediately, total combat stats refresh

  - name: "Equipment Management Flow"
    trigger: "Player wants to optimize stats before combat"
    steps:
      - "Player opens inventory screen"
      - "Player views current equipped items (helmet, armor, weapon, etc.)"
      - "Player views total stats (ATK/DEF/HP) from equipped items + pet"
      - "Player taps equipment slot to change"
      - "System shows available items of that type"
      - "Player selects new item to equip"
      - "Stats update in real-time"
      - "Player repeats for other slots as needed"
      - "Player selects active pet"
      - "Final stats displayed"
    outcome: "Player has optimized loadout for upcoming combat"
    edge_cases: |
      - No items of a type: slot shows empty/default
      - Unequipping item: stats decrease accordingly
      - Comparing items: show stat differences before equipping

secondary_flows:
  - name: "First-Time User Onboarding"
    trigger: "New user launches app for first time"
    steps:
      - "Player creates account or signs in"
      - "Tutorial overlay explains map navigation"
      - "Player guided to nearby starter location"
      - "Simplified first combat with tutorial prompts"
      - "Player wins, receives first item/pet"
      - "Tutorial explains inventory and equipping"
      - "Player equips first item"
      - "Tutorial explains crafting basics"
      - "Free access to full game"
    outcome: "Player understands core mechanics and has starter equipment"
    edge_cases: |
      - Player skips tutorial: can access from settings later
      - No nearby locations: tutorial uses virtual location

  - name: "Style Discovery Flow"
    trigger: "Player encounters enemy with distinct visual style (based on enemy type)"
    steps:
      - "Player initiates normal encounter"
      - "Style animation/effect plays (pixel_art sparkles, watercolor drips, neon glow, sketch lines)"
      - "Enemy displayed with styled visual variant"
      - "Combat proceeds normally"
      - "On victory: styled item/pet added to inventory"
      - "Special notification: '[Style] [Name] collected!' (e.g., 'Pixel Art Wolf collected!')"
      - "Style badge/marker visible in inventory showing style type"
    outcome: "Player collects styled variant with unique visual appearance"
    edge_cases: |
      - Player loses styled combat: styled variant is lost, cannot retry
      - Style determined by enemy type, not random chance
      - Multiple style types available: pixel_art, watercolor, neon, sketch

  - name: "Premium Item Discovery Flow"
    trigger: "Player visits special premium item location"
    steps:
      - "Player sees premium item marker on map (distinct icon)"
      - "Player navigates to single-location premium spawn"
      - "Player taps location"
      - "System checks premium currency balance"
      - "Player spends premium currency to unlock encounter"
      - "Combat proceeds with premium enemy"
      - "On victory: premium item (overrides city stats) collected"
    outcome: "Player obtains exclusive premium item with unique stats"
    edge_cases: |
      - Insufficient premium currency: prompt to purchase
      - Premium location only spawns once per day/week
