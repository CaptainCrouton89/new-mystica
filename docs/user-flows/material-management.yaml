title: Material Management
template: ~/.claude/file-templates/init-project/user-flows/user-flow-title.yaml
status: draft
last_updated: 2025-01-27

key_personas:
  - "Optimizer - Experiments with material combinations for best stats"
  - "Collector - Seeks all styled material variants"
  - "Casual Crafter - Applies materials for visual customization"

primary_flows:
  - name: "Craft Material onto Item Flow (via Crafting Screen)"
    trigger: "Player wants to apply a material to an item to enhance stats and appearance"
    steps:
      - "Player opens crafting screen from main menu OR taps 'Craft' on item/material in inventory"
      - "If accessed from item: item pre-filled in left slot, material slot empty"
      - "If accessed from material: material pre-filled in right slot, item slot empty"
      - "If accessed from main menu: both slots empty"
      - "Player taps empty item slot (left side) → drawer opens showing ALL items"
      - "Item drawer displays items with rarity-based border colors and equipped status badge"
      - "Player selects item from drawer → item fills left slot"
      - "Player taps empty material slot (right side) → drawer opens showing ALL materials"
      - "Material drawer displays MaterialStacks with style-based border colors and quantity"
      - "System filters out materials already applied to selected item (no duplicates, max 3)"
      - "Player selects material from drawer → material fills right slot"
      - "System displays stat preview between slots:"
      - "  - Left: Original item image with current stats"
      - "  - Middle: '+' symbol and material icon"
      - "  - Right: Question mark (no preview image) with projected stats"
      - "  - Stats that increase shown in green/larger font, decreases in red/smaller font"
      - "Player taps 'Craft' button to confirm"
      - "System decrements MaterialStack quantity by 1"
      - "System creates MaterialInstance and links via ItemMaterials table"
      - "System checks ItemImageCache for existing combo image (combo_hash lookup)"
      - "If new combo: AI image generation starts (20s synchronous blocking for MVP0)"
      - "System displays generation progress: 'Crafting your item... 15s remaining'"
      - "Generated image uploaded to R2 and cached in ItemImageCache"
      - "Item stats recalculated with new material modifiers"
      - "Updated item displayed with new image, stats, and applied materials list"
      - "System shows craft count: 'X players have crafted this combo' if > 1"
      - "Success screen with 'View Item' or 'Return to Crafting' options"
    outcome: "Player successfully crafts material onto item via dedicated crafting screen"
    edge_cases: |
      - Item already has 3 materials: material selection drawer shows warning, materials greyed out
      - Material quantity = 0: material greyed out in drawer, not selectable
      - Same material already applied to item: filtered from material drawer
      - Image generation fails: retry option or fallback to base appearance
      - Player exits during 20s generation: process continues, item updated on return
      - Network error during generation: local retry with exponential backoff
      - Equipped item selected: badge shown, crafting still allowed (stats update immediately)

  - name: "Remove Materials Flow"
    trigger: "Player wants to remove material from enhanced item"
    steps:
      - "Player opens inventory and selects enhanced item"
      - "Player views item detail screen showing applied materials"
      - "Player taps 'Remove Material' button on specific material slot"
      - "System displays removal confirmation with gold cost (100 × item level)"
      - "System shows current gold balance and cost breakdown"
      - "Player confirms material removal"
      - "System validates sufficient gold balance"
      - "System deducts gold cost from player balance"
      - "System deletes ItemMaterials junction record"
      - "System deletes MaterialInstance record"
      - "System increments MaterialStack quantity (returns material to inventory)"
      - "System recomputes combo_hash for remaining materials"
      - "System checks ItemImageCache for new combo or base item image"
      - "If new combo needed: AI generation triggers (20s sync blocking)"
      - "Item stats recalculated without removed material"
      - "Updated item displayed with new image and stats"
      - "System updates craft count for new combo if applicable"
    outcome: "Player removes material from item, pays gold cost, material returns to stack"
    edge_cases: |
      - Insufficient gold: error message with current balance vs. required
      - No materials applied: remove button disabled
      - Last material removed: item reverts to base appearance and stats
      - Network error during removal: transaction rollback, no changes applied
      - Player cancels during generation: removal already processed, generation continues

  - name: "Material Collection & Stacking Flow"
    trigger: "Player defeats enemy and receives material drop"
    steps:
      - "Combat victory screen displays rewards: gold + material drop"
      - "System determines material type and style variant (styled enemy = 100% styled material drop)"
      - "Material notification appears: '[Material Name] collected!' with visual effect"
      - "If styled material: special animation and '[Style] [Material] collected!' message"
      - "System checks existing MaterialStack for (user_id, material_id, style_id)"
      - "If stack exists: increment quantity by 1"
      - "If new stack: create MaterialStack record with quantity = 1"
      - "Player can tap material notification to view details"
      - "Material automatically added to inventory without player action"
      - "Inventory badge updates to show new material count"
    outcome: "Player receives material drop that auto-stacks in inventory for future use"
    edge_cases: |
      - No material drop (40% chance): only gold and item rewards shown
      - First time collecting styled material: tutorial tooltip explains rarity
      - Player inventory at capacity: materials still stack (no inventory limit)
      - Network error during collection: material added on next sync

  - name: "Material Preview Flow"
    trigger: "Player wants to preview material effects before applying"
    steps:
      - "Player opens material application screen"
      - "Player hovers/long-presses on material in selection list"
      - "System displays detailed material preview popup"
      - "Preview shows material description and stat modifiers"
      - "Preview shows before/after stat comparison for target item"
      - "Preview layout: Left (original item), Middle (material + '='), Right (question mark - no visual preview)"
      - "Stats displayed with visual emphasis: increases (green, larger), decreases (red, smaller)"
      - "If styled material: shows material style but no final item preview"
      - "Player can cycle through multiple materials for comparison"
      - "Player can see combined stat effects when selecting multiple materials"
      - "Player taps 'Apply' from preview or closes to continue browsing"
    outcome: "Player makes informed decision about material application with stat preview but no visual spoilers"
    edge_cases: |
      - Material would cause negative stats: warning indicator in preview
      - Styled vs normal preview: material style shown but no final result preview
      - Multiple materials selected: shows cumulative stat changes with question mark for result
      - Preview timeout: popup auto-closes after 30 seconds of inactivity
      - No visual spoilers: question mark maintains surprise element

secondary_flows:
  - name: "Quick Craft from Inventory Flow"
    trigger: "Player browsing inventory wants to craft material onto specific item"
    steps:
      - "Player opens inventory and browses All Items or All Materials section"
      - "Player taps item card → four-action menu appears: 'Equip', 'Craft', 'Upgrade', 'Sell'"
      - "Player taps 'Craft' option → navigates to crafting screen"
      - "Crafting screen opens with selected item pre-filled in left slot"
      - "Material slot (right) is empty and ready for player selection"
      - "Player taps material slot → drawer opens with filtered materials (excluding duplicates)"
      - "Player selects material → stat preview displays → confirms craft"
      - "OR: Player taps material card → 'Craft' option appears"
      - "Player taps 'Craft' → navigates to crafting screen"
      - "Crafting screen opens with selected material pre-filled in right slot"
      - "Item slot (left) is empty and ready for player selection"
      - "Player taps item slot → drawer opens with all items → selects item"
      - "Stat preview displays → player confirms craft"
    outcome: "Player quickly initiates crafting from inventory context with item/material pre-selected"
    edge_cases: |
      - Item already has 3 materials: 'Craft' button disabled with tooltip "Maximum materials applied"
      - Material quantity = 0: 'Craft' button disabled with tooltip "No materials available"
      - Player changes mind: can tap item/material slot again to select different one

  - name: "Replace Materials Flow"
    trigger: "Player wants to replace existing material with different one"
    steps:
      - "Player opens enhanced item detail screen"
      - "Player taps 'Replace Material' on specific material slot"
      - "System explains replacement process: remove old + apply new"
      - "System displays removal cost (100 × item level) and confirms"
      - "Player confirms removal and pays gold cost"
      - "Material removal flow executes (returns to stack)"
      - "System automatically opens material application screen"
      - "Player selects new material from available stacks"
      - "Material application flow executes (consumes from stack)"
      - "Final result: item has new material, gold spent, two-step process complete"
    outcome: "Player successfully replaces one material with another through two-step process"
    edge_cases: |
      - Insufficient gold for removal: replacement process blocked
      - No replacement materials available: warning shown before removal
      - Player cancels after removal: old material returned to stack, slot empty
      - Generation fails on reapplication: item remains with removed material slot empty

  - name: "Material Inventory Management Flow"
    trigger: "Player wants to view and organize material collection"
    steps:
      - "Player opens inventory and navigates to materials tab"
      - "System displays MaterialStacks grouped by material type"
      - "Each stack shows material name, quantity, and style variant"
      - "Player can filter by material theme (offensive, defensive, balanced, etc.)"
      - "Player can filter by style type (normal, pixel_art, watercolor, neon, holographic)"
      - "Player can sort by quantity, rarity tier, or recently collected"
      - "Player taps material to view detailed stats and description"
      - "Player can see which items currently use each material type"
      - "Player can access quick-apply option to apply to recent items"
    outcome: "Player efficiently manages material collection and understands inventory"
    edge_cases: |
      - Empty material inventory: tutorial prompt to engage in combat for drops
      - Large collection: pagination or virtualized scrolling for performance
      - Material search functionality for players with 50+ unique materials

  - name: "Craft Count Discovery Flow"
    trigger: "Player applies material combo that other players have crafted"
    steps:
      - "Player completes material application process"
      - "System checks ItemImageCache craft_count for combo_hash"
      - "If craft_count > 1: special notification appears"
      - "System displays: 'X players have crafted this combo!' with celebration effect"
      - "Player can tap notification to see craft popularity details"
      - "Popular combo badge appears on item in inventory"
      - "Player can share screenshot of popular combo creation"
    outcome: "Player discovers community crafting patterns and feels connected to other players"
    edge_cases: |
      - First-ever craft (craft_count = 1): 'You're the first to craft this!' message
      - Very popular combo (100+ crafts): special 'legendary combo' designation
      - Player privacy settings: can opt out of craft count tracking

  - name: "Material Recovery Tutorial Flow"
    trigger: "First-time player removes material from item"
    steps:
      - "Player attempts first material removal"
      - "System detects first-time removal action"
      - "Tutorial popup explains removal process and gold cost"
      - "Tutorial emphasizes material returns to stack for reuse"
      - "Tutorial shows gold cost calculation (100 × item level)"
      - "Player can choose to proceed or cancel tutorial removal"
      - "If proceeding: tutorial highlights each step of removal process"
      - "Tutorial concludes with tips about strategic material management"
    outcome: "Player understands material removal mechanics and cost implications"
    edge_cases: |
      - Player skips tutorial: can access help section later
      - Very expensive removal: additional warning for high-level items
      - Player has insufficient gold: tutorial explains gold earning methods